name: Deploy Node.js app to EC2 on push

on:
  push:
    branches:
      - new-main  # or master, or whatever the main branch is

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e # â— Exit on error: Aborts if any command fails to prevent half-broken deployments.
          
          echo "ğŸ” Detecting OS and installing build tools..."
          if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y build-essential
          elif command -v yum &> /dev/null; then
            sudo yum groupinstall -y "Development Tools"
            sudo yum install -y gcc-c++ make
          else
            echo "âŒ Unsupported OS: cannot install build tools"
            exit 1 # Mark GitHub Action as failed to notify you
          fi

          # === ğŸ›¡ï¸ Backup the current version ===
          BACKUP_DIR=~/my-node-express-backups
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          mkdir -p $BACKUP_DIR
          cp -r ~/my-node-express $BACKUP_DIR/my-node-express_$TIMESTAMP
          echo "âœ… Backup created at $BACKUP_DIR/my-node-express_$TIMESTAMP"

          # === ğŸš€ Pull and deply new version ===
          echo "ğŸš€ Pulling latest code..."
          cd ~/my-node-express 
          git fetch --all
          git reset --hard origin/new-main

          echo "ğŸ“¦ Installing dependencies..."
          rm -rf node_modules # â— Clean Windows-compatible modules
          npm ci --production || exit 1 # â— Reinstall fresh Linux-compatible dependencies

          # === ğŸ”¥ Run the server using pm2 ===
          echo "ğŸ”„ Reloading server with PM2..."
          pm2 reload my-api-server || pm2 start index.js --name "my-api-server"
          
          echo "ğŸ©º Health checking server..."
          sleep 10 # wait for server to properly start
          
          # My own server's healthcheck endpoint
          HEALTHCHECK_URL='http://52.59.130.11:3000/health'
          echo "Healthcheck URL: $HEALTHCHECK_URL"
          curl -v $HEALTHCHECK_URL || echo "âŒ Curl failed"

          if curl --fail --silent $HEALTHCHECK_URL; then
            echo "âœ… Server is healthy. Deployment complete!"
            exit 0 # Mark GitHub Action as successful
          else
            echo "âŒ Healthcheck failed! Rolling back..."

            echo "ğŸ›‘ Stopping broken server..."
            pm2 stop my-api-server || true

            echo "â™»ï¸ Restoring previous backup..."
            rm -rf ~/my-node-express
            cp -r $BACKUP_DIR/my-node-express_$TIMESTAMP ~/my-node-express

            echo "ğŸš€ Restarting server with backup..."
            cd ~/my-node-express
            npm install
            pm2 start index.js --name "my-api-server"

            echo "âœ… Rollback successful!"
            exit 0  
          fi

          echo -e "\033[1;32mğŸ Finished deploy script.\033[0m"


